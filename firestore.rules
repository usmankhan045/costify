rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to get project data
    function getProject(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)).data;
    }
    
    // Helper function to check if user is project admin
    // Returns false if project doesn't exist or can't be accessed
    function isProjectAdmin(projectId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/projects/$(projectId)) &&
        getProject(projectId).adminId == request.auth.uid;
    }
    
    // Helper function to check if user can remove members from a project
    // Returns false if project doesn't exist
    function canRemoveMembers(projectId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/projects/$(projectId)) && (
        getProject(projectId).adminId == request.auth.uid ||
        (getProject(projectId).directorPermissions[request.auth.uid] != null &&
         getProject(projectId).directorPermissions[request.auth.uid].canDeleteMembers == true)
      );
    }
    
    // Helper function to check if user can delete expenses (admin or director with permission)
    // Returns false if project doesn't exist
    function canDeleteExpenses(projectId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/projects/$(projectId)) && (
        getProject(projectId).adminId == request.auth.uid ||
        (getProject(projectId).directorPermissions[request.auth.uid] != null &&
         getProject(projectId).directorPermissions[request.auth.uid].canDeleteExpenses == true)
      );
    }
    
    // Helper function to check if updater is admin of any project in a list
    // Used when removing project IDs during project deletion or member removal
    // Checks up to 10 projects to cover most cases
    function isAdminOfAnyProject(projectIds) {
      return projectIds.size() > 0 && (
        isProjectAdmin(projectIds[0]) ||
        (projectIds.size() > 1 && isProjectAdmin(projectIds[1])) ||
        (projectIds.size() > 2 && isProjectAdmin(projectIds[2])) ||
        (projectIds.size() > 3 && isProjectAdmin(projectIds[3])) ||
        (projectIds.size() > 4 && isProjectAdmin(projectIds[4])) ||
        (projectIds.size() > 5 && isProjectAdmin(projectIds[5])) ||
        (projectIds.size() > 6 && isProjectAdmin(projectIds[6])) ||
        (projectIds.size() > 7 && isProjectAdmin(projectIds[7])) ||
        (projectIds.size() > 8 && isProjectAdmin(projectIds[8])) ||
        (projectIds.size() > 9 && isProjectAdmin(projectIds[9]))
      );
    }
    
    // ============ USERS COLLECTION ============
    match /users/{userId} {
      // Anyone authenticated can read user profiles
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      allow create: if isOwner(userId);
      
      // Users can update their own profile
      // OR project admin/director can update projectIds when removing member or deleting project
      allow update: if isOwner(userId) || (
        isAuthenticated() &&
        // Only allow updating projectIds and updatedAt fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['projectIds', 'updatedAt']) &&
        // Check that we're only removing project IDs (new list is subset of old list)
        request.resource.data.projectIds.size() < resource.data.projectIds.size() &&
        // Verify that the updater is admin of at least one project in the old list
        // This allows project admins to remove project IDs when deleting projects
        // or when removing members from projects
        resource.data.projectIds.size() > 0 &&
        isAdminOfAnyProject(resource.data.projectIds)
      );
      
      allow delete: if isOwner(userId);
    }
    
    // ============ PROJECTS COLLECTION ============
    match /projects/{projectId} {
      // Allow read if user is admin or their ID is in projectIds of the user doc
      allow read: if isAuthenticated();
      
      // Any authenticated user can create a project (they become admin)
      allow create: if isAuthenticated() && 
        request.resource.data.adminId == request.auth.uid;
      
      // Admin can update project, OR user can add themselves to members (for invitations)
      // OR director with permission can remove members
      // When accepting invitation, user can only update 'members' and 'updatedAt' fields
      allow update: if isAuthenticated() && (
        resource.data.adminId == request.auth.uid ||
        canRemoveMembers(projectId) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'updatedAt']))
      );
      
      // Only admin can delete project
      allow delete: if isAuthenticated() && 
        resource.data.adminId == request.auth.uid;
    }
    
    // ============ EXPENSES COLLECTION ============
    match /expenses/{expenseId} {
      // Allow read if user is authenticated
      // Client-side filtering handles role-based access (labour users see only their own)
      allow read: if isAuthenticated();
      
      // Authenticated users can create expenses
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      
      // Creator can update pending expenses, admin/director can update any
      allow update: if isAuthenticated() && (
        // Creator can edit their own pending expenses
        (resource.data.createdBy == request.auth.uid && 
         resource.data.status == 'pending') ||
        // Admin can edit any expense
        isProjectAdmin(resource.data.projectId) ||
        // Director with delete permission can edit any expense
        canDeleteExpenses(resource.data.projectId) ||
        // Allow if updating status to approved/rejected (directors can approve)
        // Client-side enforces that only admins/directors can see approve buttons
        (request.resource.data.status != resource.data.status && 
         request.resource.data.status in ['approved', 'rejected'] &&
         resource.data.status == 'pending')
      );
      
      // Creator can delete pending expenses, admin/director with permission can delete any
      // Also allow admin to delete expenses when deleting project (checked via projectId)
      allow delete: if isAuthenticated() && (
        (resource.data.createdBy == request.auth.uid && 
         resource.data.status == 'pending') ||
        canDeleteExpenses(resource.data.projectId) ||
        // Allow admin to delete expenses when deleting project
        isProjectAdmin(resource.data.projectId)
      );
    }
    
    // ============ INVITATIONS COLLECTION ============
    match /invitations/{invitationId} {
      // Anyone authenticated can read invitations
      allow read: if isAuthenticated();
      
      // Authenticated users can create invitations
      allow create: if isAuthenticated();
      
      // Anyone authenticated can accept (update) an invitation
      allow update: if isAuthenticated();
      
      // Creator can delete invitations, or admin can delete when deleting project
      allow delete: if isAuthenticated() && (
        resource.data.invitedBy == request.auth.uid ||
        // Allow admin to delete invitations when deleting project
        isProjectAdmin(resource.data.projectId)
      );
    }
    
    // ============ NOTIFICATIONS COLLECTION ============
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // System creates notifications
      allow create: if isAuthenticated();
      
      // Users can mark their notifications as read
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
  }
}